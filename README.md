# DataSync Library

Th∆∞ vi·ªán JavaScript nh·∫π v√† m·∫°nh m·∫Ω ƒë·ªÉ qu·∫£n l√Ω ƒë·ªìng b·ªô d·ªØ li·ªáu v·ªõi server, t√≠ch h·ª£p cache th√¥ng minh v√† loading states.

## ‚ú® T√≠nh nƒÉng ch√≠nh

- üöÄ **Cache th√¥ng minh**: T·ª± ƒë·ªông cache parameters ƒë·ªÉ tr√°nh request tr√πng l·∫∑p
- üîÑ **Loading states**: Qu·∫£n l√Ω tr·∫°ng th√°i loading v·ªõi hooks t√πy ch·ªânh v√† debounce 600ms
- üìù **Message handling**: X·ª≠ l√Ω th√¥ng b√°o l·ªói v√† th√†nh c√¥ng
- üîå **Interceptors**: Middleware cho request/response v·ªõi Headers t√πy ch·ªânh
- üåê **RESTful**: H·ªó tr·ª£ ƒë·∫ßy ƒë·ªß GET, POST, PUT, PATCH v√† DELETE
- üì¶ **Path params**: H·ªó tr·ª£ URL c√≥ path parameters (/api/users/:id)
- üéØ **FormData**: T·ª± ƒë·ªông x·ª≠ l√Ω c·∫£ JSON v√† FormData payloads

## üöÄ C√†i ƒë·∫∑t

```bash
# Copy file v√†o project c·ªßa b·∫°n
# Import ES6 module
import { registerGetEndpoint } from './main.js'
```

## üí° S·ª≠ d·ª•ng c∆° b·∫£n

### 1. ƒêƒÉng k√Ω endpoints

```javascript
import { 
    registerGetEndpoint,
    registerPostEndpoint,
    registerPutEndpoint,
    registerPatchEndpoint,
    registerDeleteEndpoint,
    requestHandlers 
} from './main.js';

// ƒêƒÉng k√Ω GET endpoint v·ªõi path params
registerGetEndpoint('getUser', '/api/users/:id');
registerGetEndpoint('searchUsers', '/api/users/search', 'no-cache');

// ƒêƒÉng k√Ω POST endpoint v·ªõi FormData support
registerPostEndpoint('createUser', '/api/users');
registerPostEndpoint('uploadAvatar', '/api/users/:id/avatar');

// PUT, PATCH v√† DELETE endpoints
registerPutEndpoint('replaceUser', '/api/users/:id');
registerPatchEndpoint('updateUser', '/api/users/:id'); 
registerDeleteEndpoint('deleteUser', '/api/users/:id');
```

### 2. G·ªçi API

```javascript
// GET request v·ªõi path params v√† query params 
const user = await requestHandlers.getUser({ 
    id: 123,          // path param (:id)
    fields: 'name,email'  // query param
});

// GET request no-cache (lu√¥n fetch m·ªõi)
const searchResults = await requestHandlers.searchUsers({ 
    q: 'john' 
});

// POST request v·ªõi JSON body
const newUser = await requestHandlers.createUser({
    name: 'John Doe',
    email: 'john@example.com'
});

// POST request v·ªõi FormData v√† path params
const formData = new FormData();
formData.append('avatar', file);
await requestHandlers.uploadAvatar(formData, { id: 123 });

// PUT vs PATCH request (thay th·∫ø vs c·∫≠p nh·∫≠t m·ªôt ph·∫ßn)
await requestHandlers.replaceUser({
    name: 'John Smith',
    email: 'john.smith@example.com'
}, { id: 123 });

await requestHandlers.updateUser({
    name: 'John Smith'
}, { id: 123 });

// DELETE request v·ªõi path param
await requestHandlers.deleteUser({ id: 123 });
```

### 3. Thi·∫øt l·∫≠p Loading Hooks

```javascript
import { setLoadingHooks } from './datasync.js';

setLoadingHooks({
    onQueueAdd: () => {
        // Hi·ªÉn th·ªã loading spinner
        document.getElementById('loading').style.display = 'block';
    },
    onQueueEmpty: () => {
        // ·∫®n loading spinner  
        document.getElementById('loading').style.display = 'none';
    }
});
```

### 4. X·ª≠ l√Ω Message States

```javascript
import { messageState, hasError } from './datasync.js';

// Ki·ªÉm tra l·ªói sau khi g·ªçi API
await requestHandlers.getUsers();

if (hasError()) {
    console.error('C√≥ l·ªói:', messageState.error.message);
} else if (messageState.success) {
    console.log('Th√†nh c√¥ng:', messageState.success);
}
```

### 5. Interceptors

```javascript
import { interceptors } from './main.js';

// Interceptor tr∆∞·ªõc khi g·ª≠i request
interceptors.before = async ({ params, body, headers, type }) => {
    // Th√™m authorization header
    const token = localStorage.getItem('token');
    if (token) {
        headers.append('Authorization', `Bearer ${token}`);
    }

    // Thay ƒë·ªïi header cho t·ª´ng lo·∫°i request
    if (type === 'POST' || type === 'PUT' || type === 'PATCH') {
        if (!(body instanceof FormData)) {
            headers.append('Content-Type', 'application/json');
        }
    }
    
    console.log(`${type} request:`, { params, body });
};

// Interceptor sau khi nh·∫≠n response
interceptors.after = (result) => {
    console.log('Response received:', result);
    
    // X·ª≠ l√Ω token m·ªõi
    if (result.newToken) {
        localStorage.setItem('token', result.newToken);
    }

    // X·ª≠ l√Ω refresh token
    if (result.code === 'TOKEN_EXPIRED') {
        // Refresh token logic
    }
};
```

## üìö API Reference 

### Core Functions

#### `registerGetEndpoint(name, url, mode?)`
ƒêƒÉng k√Ω m·ªôt GET endpoint.

- `name`: T√™n unique cho endpoint
- `url`: URL c·ªßa API endpoint, c√≥ th·ªÉ ch·ª©a path params (v√≠ d·ª•: `/api/users/:id`)
- `mode`: `'no-cache'` ƒë·ªÉ disable cache (optional)

#### `registerPostEndpoint(name, url)`
ƒêƒÉng k√Ω m·ªôt POST endpoint.

- `name`: T√™n unique cho endpoint  
- `url`: URL c·ªßa API endpoint, h·ªó tr·ª£ c·∫£ JSON body v√† FormData

#### `registerPutEndpoint(name, url)`
ƒêƒÉng k√Ω m·ªôt PUT endpoint ƒë·ªÉ thay th·∫ø ho√†n to√†n resource.

- `name`: T√™n unique cho endpoint
- `url`: URL c·ªßa API endpoint

#### `registerPatchEndpoint(name, url)`
ƒêƒÉng k√Ω m·ªôt PATCH endpoint ƒë·ªÉ c·∫≠p nh·∫≠t m·ªôt ph·∫ßn resource.

- `name`: T√™n unique cho endpoint
- `url`: URL c·ªßa API endpoint

#### `registerDeleteEndpoint(name, url)`  
ƒêƒÉng k√Ω m·ªôt DELETE endpoint.

- `name`: T√™n unique cho endpoint
- `url`: URL c·ªßa API endpoint

#### `setLoadingHooks({ onQueueAdd, onQueueEmpty })`
Thi·∫øt l·∫≠p callbacks cho loading states v·ªõi debounce 600ms.

- `onQueueAdd`: Callback khi c√≥ request m·ªõi
- `onQueueEmpty`: Callback khi h·∫øt request

### Data Stores

#### `dataStore` 
Map ch·ª©a d·ªØ li·ªáu sau khi sync t·ª´ server.

```javascript
import { dataStore } from './main.js';

// L·∫•y d·ªØ li·ªáu ƒë√£ cache
const cachedUsers = dataStore.get('getUsers');
```

#### `messageState`
Object ch·ª©a tr·∫°ng th√°i message.

```javascript
const { error, success } = messageState;
```

#### `paramCache`
Map ch·ª©a cache c·ªßa parameters ƒë·ªÉ tr√°nh duplicate requests cho GET requests.

### Request Handlers

#### `requestHandlers[name](params)`
GET v√† DELETE requests nh·∫≠n m·ªôt object params:
- Path params s·∫Ω thay th·∫ø v√†o URL (v√≠ d·ª•: `:id`)
- C√°c params c√≤n l·∫°i s·∫Ω tr·ªü th√†nh query string

#### `requestHandlers[name](body, params)`
POST, PUT v√† PATCH requests nh·∫≠n:
- body: JSON object ho·∫∑c FormData instance
- params: Object ch·ª©a path params v√† query params

### Utility Functions

#### `hasError()`
Ki·ªÉm tra c√≥ l·ªói x·∫£y ra kh√¥ng.

```javascript
if (hasError()) {
    // X·ª≠ l√Ω l·ªói
}
```

#### `interceptors`
Object ch·ª©a c√°c interceptors:
- `before`: Ch·∫°y tr∆∞·ªõc khi g·ª≠i request, c√≥ th·ªÉ modify headers
- `after`: Ch·∫°y sau khi nh·∫≠n response, x·ª≠ l√Ω k·∫øt qu·∫£ chung
```

## üéØ C√°c t√¨nh hu·ªëng s·ª≠ d·ª•ng

### React Integration

```javascript
import { useEffect, useState } from 'react';
import { requestHandlers, setLoadingHooks, messageState } from './datasync.js';

function UserList() {
    const [users, setUsers] = useState([]);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        setLoadingHooks({
            onQueueAdd: () => setLoading(true),
            onQueueEmpty: () => setLoading(false)
        });

        loadUsers();
    }, []);

    const loadUsers = async () => {
        const data = await requestHandlers.getUsers();
        if (data) setUsers(data);
    };

    return (
        <div>
            {loading && <div>Loading...</div>}
            {messageState.error && <div>Error: {messageState.error.message}</div>}
            {users.map(user => <div key={user.id}>{user.name}</div>)}
        </div>
    );
}
```

### Vanilla JavaScript

```javascript
// Kh·ªüi t·∫°o
registerGetEndpoint('getProducts', '/api/products');
setLoadingHooks({
    onQueueAdd: () => showSpinner(),
    onQueueEmpty: () => hideSpinner()
});

// S·ª≠ d·ª•ng
document.getElementById('loadBtn').addEventListener('click', async () => {
    const products = await requestHandlers.getProducts({ category: 'electronics' });
    renderProducts(products);
});
```

## ‚öôÔ∏è Configuration

### Response Format
Library mong ƒë·ª£i response c√≥ format:

```javascript
// Success response
{
    "code": "SUCCESS",  // ho·∫∑c kh√¥ng c√≥ code
    "data": [...],      // ho·∫∑c "result": [...]
    "message": "Optional success message"
}

// Error response  
{
    "code": "ERROR",    // ho·∫∑c b·∫•t k·ª≥ code n√†o kh√°c SUCCESS
    "message": "Error description",
    "result": false     // ho·∫∑c status code kh√¥ng ph·∫£i 2xx
}
```

### Request Handling
- Loading spinner hi·ªÉn th·ªã sau 600ms ƒë·ªÉ tr√°nh flash
- T·ª± ƒë·ªông x·ª≠ l√Ω Content-Type cho JSON v√† FormData
- T·ª± ƒë·ªông parse response.json()
- T·ª± ƒë·ªông x·ª≠ l√Ω path params trong URL
- Cache ch·ªâ √°p d·ª•ng cho GET requests c√≥ mode !== 'no-cache'

### Path Parameters
```javascript
// URL: /api/users/:id/posts/:postId
registerGetEndpoint('getPost', '/api/users/:id/posts/:postId');

// G·ªçi API:
const post = await requestHandlers.getPost({
    id: 123,        // -> thay th·∫ø :id
    postId: 456,    // -> thay th·∫ø :postId
    fields: 'title,content'  // -> tr·ªü th√†nh query param
});

// -> GET /api/users/123/posts/456?fields=title,content
```

## üîß Advanced Usage

### Error Handling

```javascript
import { messageState, hasError } from './main.js';

// S·ª≠ d·ª•ng try-catch
try {
    await requestHandlers.createUser(userData);
    if (messageState.success) {
        showNotification(messageState.success);
    }
} catch (error) {
    console.error(error);
}

// Ho·∫∑c ki·ªÉm tra sau khi g·ªçi
const result = await requestHandlers.createUser(userData);
if (hasError()) {
    console.error(messageState.error);
} else {
    console.log('Success:', result);
}
```

### Custom Headers & Auth

```javascript
import { interceptors } from './main.js';

// Th√™m auth v√† custom headers
interceptors.before = async ({ headers, type }) => {
    // Auth header
    const token = localStorage.getItem('token');
    if (token) {
        headers.append('Authorization', `Bearer ${token}`);
    }

    // Custom header cho t·ª´ng lo·∫°i request
    if (type === 'GET') {
        headers.append('X-Custom', 'value');
    }
};

// Refresh token handling
interceptors.after = async (result) => {
    if (result.code === 'TOKEN_EXPIRED') {
        const newToken = await refreshToken();
        localStorage.setItem('token', newToken);
        // C√≥ th·ªÉ retry request c≈©
    }
};
```

### Multiple Environments

```javascript
const API_BASE = process.env.NODE_ENV === 'production' 
    ? 'https://api.example.com' 
    : 'http://localhost:3000';

// ƒêƒÉng k√Ω endpoint v·ªõi base URL
const endpoints = {
    getUser: '/api/users/:id',
    createUser: '/api/users',
    // ...
};

Object.entries(endpoints).forEach(([name, path]) => {
    const url = API_BASE + path;
    if (path.includes('/:')) {
        registerGetEndpoint(name, url);
    } else {
        registerPostEndpoint(name, url);
    }
});
```

## ü§ù Contributing

1. Fork repository
2. T·∫°o feature branch (`git checkout -b feature/AmazingFeature`)
3. Commit changes (`git commit -m 'Add some AmazingFeature'`)
4. Push to branch (`git push origin feature/AmazingFeature`)
5. T·∫°o Pull Request

## üìÑ License

MIT License - see LICENSE file for details.
